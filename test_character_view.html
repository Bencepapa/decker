<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Character View Test</title>
    <link rel="stylesheet" href="cards.css">
    <link rel="stylesheet" href="all.css">
    <style>
        body {
            background: #111;
            color: #fff;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-header {
            text-align: center;
            margin-bottom: 20px;
            color: #0f0;
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .popup-content {
            background: #222;
            border: 2px solid #0f0;
            border-radius: 8px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>Modern Character View Test</h1>
            <p>Click the button below to test the modern character view</p>
        </div>
        <button onclick="openCharacterView()" style="background: #0f0; color: #000; border: none; padding: 10px 20px; font-size: 16px; cursor: pointer;">
            Open Modern Character View
        </button>
    </div>

    <script src="cards.js"></script>
    <script>
        // Mock game data for testing
        window.g_pChar = {
            m_szName: "TestRunner",
            m_nCredits: 5000,
            m_nRepLevel: 8,
            m_nHealthPhysical: 7,
            m_nSkillPoints: 12,
            m_nAttackSkill: 3,
            m_nDefenseSkill: 2,
            m_nStealthSkill: 4,
            m_nAnalysisSkill: 5,
            m_nProgrammingSkill: 6,
            m_nChipDesignSkill: 2,
            m_nLifestyle: 2,
            m_nMonth: 5,
            m_nDayOfMonth: 15,
            m_nYear: 2064,
            m_bOnRun: false,
            GetLifestyleString: () => ["Street", "Squat", "Apartment", "House", "Mansion"][this.m_nLifestyle] || "Unknown",
            GenerateShopItems: () => console.log("Shop items generated"),
            ClearContracts: () => console.log("Contracts cleared"),
            GenerateContracts: () => console.log("Contracts generated")
        };

        window.g_szRepLevelString = ["Unknown", "Thug", "Punk", "Hacker", "Runner", "Pro", "Elite", "Legend", "Master"];
        window.HEALTH_INCREMENT = 10;
        window.MAX_LIFESTYLE = 4;
        window.g_nLifestyleMonthlyCost = [0, 100, 500, 2000, 5000, 10000];

        // Mock helper functions
        window.GetDays = (month, year) => [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month] || 30;
        
        // Mock Popup system
        window.Popup = {
            onclick: (element, handler) => {
                if (element) element.onclick = handler;
            },
            create: (name, obj) => ({
                onInit: (handler) => {
                    handler();
                    return this;
                },
                onKey: (keys) => this
            }),
            close: () => {
                const overlay = document.querySelector('.popup-overlay');
                if (overlay) overlay.remove();
            },
            deckview: () => {
                console.log("Opening deck view...");
            },
            alert: (message) => {
                alert(message);
            }
        };

        // Mock HTMLbuilder
        window.HTMLbuilder = (structure) => {
            const elements = [];
            
            function createElement(def) {
                if (Array.isArray(def)) {
                    const [tag, isElement, props, children] = def;
                    const element = document.createElement(tag);
                    
                    if (props) {
                        Object.keys(props).forEach(key => {
                            if (key === 'textContent') {
                                element.textContent = props[key];
                            } else if (key === 'className') {
                                element.className = props[key];
                            } else if (key === 'style' && typeof props[key] === 'object') {
                                Object.keys(props[key]).forEach(styleKey => {
                                    element.style[styleKey] = props[key][styleKey];
                                });
                            } else {
                                element.setAttribute(key, props[key]);
                            }
                        });
                    }
                    
                    if (children) {
                        if (Array.isArray(children)) {
                            children.forEach(child => {
                                if (typeof child === 'object' && child !== null) {
                                    const childElement = createElement(child);
                                    if (childElement) element.appendChild(childElement);
                                } else if (typeof child === 'string') {
                                    element.appendChild(document.createTextNode(child));
                                }
                            });
                        } else if (typeof children === 'object') {
                            // Handle case where children is not an array but an object definition
                            const childElement = createElement(children);
                            if (childElement) element.appendChild(childElement);
                        }
                    }
                    
                    if (isElement === true) {
                        elements.push(element);
                    }
                    return element;
                }
                return null;
            }
            
            const root = createElement(structure);
            return [...elements, root];
        };

        let characterViewData = null;

        function openCharacterView() {
            // Create the modern character view
            const [obj, h2, nameCard, moneyCard, repCard, skillPtsCard, healthCard, rentCard, 
                 skillsContainer, lifestyleCard, btnDeck, btnClose] = HTMLbuilder(
                ["div", true, {className:"modern-ui"}, [
                        ["h2", true],
                        ["div", {style:{padding:"16px", display:"flex", flexDirection:"column", gap:"16px", flex:1, overflowY:"auto", minWidth:"600px", maxWidth:"800px"}}, [
                                // Character Info Grid (top row)
                                ["div", {className:"character-info-grid"}, [
                                        ["div", {className:"card-stat-big"}, [
                                                ["div", true, {className:"stat-big-value"}], // nameCard
                                                ["div", {className:"stat-big-label", textContent:"Name"}],
                                        ]],
                                        ["div", {className:"card-stat-big"}, [
                                                ["div", true, {className:"stat-big-value"}], // moneyCard
                                                ["div", {className:"stat-big-label", textContent:"Credits"}],
                                        ]],
                                        ["div", {className:"card-stat-big"}, [
                                                ["div", true, {className:"stat-big-value"}], // repCard
                                                ["div", {className:"stat-big-label", textContent:"Reputation"}],
                                        ]],
                                        ["div", {className:"card-stat-big"}, [
                                                ["div", true, {className:"stat-big-value"}], // skillPtsCard
                                                ["div", {className:"stat-big-label", textContent:"Skill Points"}],
                                        ]],
                                ]],
                                
                                // Progress Cards Row (health and rent)
                                ["div", {className:"progress-cards-row"}, [
                                        ["div", {className:"card-character-stat"}, [
                                                ["div", {className:"stat-name", textContent:"Physical Health"}],
                                                ["div", {className:"stat-bar"}, [
                                                        ["div", {className:"stat-fill health"}],
                                                ]],
                                                ["div", true, {className:"stat-values"}], // healthCard
                                        ]],
                                        ["div", {className:"card-character-stat"}, [
                                                ["div", {className:"stat-name", textContent:"Rent Due In"}],
                                                ["div", {className:"stat-bar"}, [
                                                        ["div", {className:"stat-fill time"}],
                                                ]],
                                                ["div", true, {className:"stat-values"}], // rentCard
                                        ]],
                                ]],
                                
                                // Skills Grid
                                ["div", true, {className:"skills-grid"}, [ // skillsContainer
                                        // Attack
                                        ["div", {className:"card-skill"}, [
                                                ["div", {className:"skill-header"}, [
                                                        ["div", {className:"skill-name", textContent:"Attack"}],
                                                        ["div", {className:"skill-value", textContent:"0"}],
                                                ]],
                                                ["div", {className:"skill-controls"}, [
                                                        ["div", {className:"skill-cost", textContent:"Cost: -"}],
                                                        ["button", {className:"skill-upgrade-btn", textContent:"+", disabled:true}],
                                                ]],
                                        ]],
                                        // Defense
                                        ["div", {className:"card-skill"}, [
                                                ["div", {className:"skill-header"}, [
                                                        ["div", {className:"skill-name", textContent:"Defense"}],
                                                        ["div", {className:"skill-value", textContent:"0"}],
                                                ]],
                                                ["div", {className:"skill-controls"}, [
                                                        ["div", {className:"skill-cost", textContent:"Cost: -"}],
                                                        ["button", {className:"skill-upgrade-btn", textContent:"+", disabled:true}],
                                                ]],
                                        ]],
                                        // Stealth
                                        ["div", {className:"card-skill"}, [
                                                ["div", {className:"skill-header"}, [
                                                        ["div", {className:"skill-name", textContent:"Stealth"}],
                                                        ["div", {className:"skill-value", textContent:"0"}],
                                                ]],
                                                ["div", {className:"skill-controls"}, [
                                                        ["div", {className:"skill-cost", textContent:"Cost: -"}],
                                                        ["button", {className:"skill-upgrade-btn", textContent:"+", disabled:true}],
                                                ]],
                                        ]],
                                        // Analysis
                                        ["div", {className:"card-skill"}, [
                                                ["div", {className:"skill-header"}, [
                                                        ["div", {className:"skill-name", textContent:"Analysis"}],
                                                        ["div", {className:"skill-value", textContent:"0"}],
                                                ]],
                                                ["div", {className:"skill-controls"}, [
                                                        ["div", {className:"skill-cost", textContent:"Cost: -"}],
                                                        ["button", {className:"skill-upgrade-btn", textContent:"+", disabled:true}],
                                                ]],
                                        ]],
                                        // Programming
                                        ["div", {className:"card-skill"}, [
                                                ["div", {className:"skill-header"}, [
                                                        ["div", {className:"skill-name", textContent:"Programming"}],
                                                        ["div", {className:"skill-value", textContent:"0"}],
                                                ]],
                                                ["div", {className:"skill-controls"}, [
                                                        ["div", {className:"skill-cost", textContent:"Cost: -"}],
                                                        ["button", {className:"skill-upgrade-btn", textContent:"+", disabled:true}],
                                                ]],
                                        ]],
                                        // Chip Design
                                        ["div", {className:"card-skill"}, [
                                                ["div", {className:"skill-header"}, [
                                                        ["div", {className:"skill-name", textContent:"Chip Design"}],
                                                        ["div", {className:"skill-value", textContent:"0"}],
                                                ]],
                                                ["div", {className:"skill-controls"}, [
                                                        ["div", {className:"skill-cost", textContent:"Cost: -"}],
                                                        ["button", {className:"skill-upgrade-btn", textContent:"+", disabled:true}],
                                                ]],
                                        ]],
                                ]],
                                
                                // Lifestyle Card
                                ["div", true, {className:"card-lifestyle"}, [ // lifestyleCard
                                        ["div", {className:"lifestyle-header"}, [
                                                ["div", {className:"lifestyle-title", textContent:"Current Lifestyle"}],
                                                ["div", {className:"lifestyle-current"}],
                                        ]],
                                        ["div", {className:"lifestyle-details"}, [
                                                ["div", {className:"lifestyle-detail"}, [
                                                        ["div", {className:"lifestyle-label", textContent:"Monthly Cost:"}],
                                                        ["div", {className:"lifestyle-value"}],
                                                ]],
                                                ["div", {className:"lifestyle-detail"}, [
                                                        ["div", {className:"lifestyle-label", textContent:"Days Until Due:"}],
                                                        ["div", {className:"lifestyle-value"}],
                                                ]],
                                        ]],
                                        ["div", {className:"lifestyle-upgrade"}, [
                                                ["div", {className:"lifestyle-cost"}],
                                                ["button", true, {textContent:"Upgrade Lifestyle"}],
                                        ]],
                                ]],
                                
                                // Button Row
                                ["div", {className:"btnGroup"}, [
                                        ["button", true, {textContent:"View Deck"}], // btnDeck
                                        ["button", true, {textContent:"Close"}], // btnClose
                                ]],
                        ]],
                ]],
        );

            // Store elements for updating
            characterViewData = {
                h2, nameCard, moneyCard, repCard, skillPtsCard, healthCard, rentCard,
                skillsContainer, lifestyleCard, btnDeck, btnClose
            };

            // Get skill elements for easier access
            const skillElements = skillsContainer.querySelectorAll('.card-skill');
            const skillData = [
                { name: 'Attack', getter: () => g_pChar.m_nAttackSkill, setter: (v) => g_pChar.m_nAttackSkill = v },
                { name: 'Defense', getter: () => g_pChar.m_nDefenseSkill, setter: (v) => g_pChar.m_nDefenseSkill = v },
                { name: 'Stealth', getter: () => g_pChar.m_nStealthSkill, setter: (v) => g_pChar.m_nStealthSkill = v },
                { name: 'Analysis', getter: () => g_pChar.m_nAnalysisSkill, setter: (v) => g_pChar.m_nAnalysisSkill = v },
                { name: 'Programming', getter: () => g_pChar.m_nProgrammingSkill, setter: (v) => g_pChar.m_nProgrammingSkill = v },
                { name: 'Chip Design', getter: () => g_pChar.m_nChipDesignSkill, setter: (v) => g_pChar.m_nChipDesignSkill = v }
            ];

            btnDeck.onclick = viewDeck;
            btnClose.onclick = close;

            // Add click handlers for skill upgrade buttons
            skillElements.forEach((skillCard, index) => {
                const upgradeBtn = skillCard.querySelector('.skill-upgrade-btn');
                if (upgradeBtn) {
                    upgradeBtn.onclick = () => upgradeSkill(index);
                }
            });

            // Add lifestyle upgrade handler
            const lifestyleUpgradeBtn = lifestyleCard.querySelector('.lifestyle-upgrade button');
            if (lifestyleUpgradeBtn) {
                lifestyleUpgradeBtn.onclick = upgradeLifestyle;
            }

            // Create popup overlay
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';
            const content = document.createElement('div');
            content.className = 'popup-content';
            content.appendChild(obj);
            overlay.appendChild(content);
            document.body.appendChild(overlay);

            // Initialize the view
            initFunc();

            function initFunc() {
                // Set header
                h2.textContent = g_pChar.m_szName;
                
                // Basic info cards
                nameCard.textContent = g_pChar.m_szName;
                moneyCard.textContent = g_pChar.m_nCredits + "cr";
                
                // Reputation
                let rep = g_szRepLevelString[g_pChar.m_nRepLevel];
                if (g_pChar.m_nRepLevel === ((g_pChar.m_nLifestyle + 1) * 4))
                    rep += " (Max)";
                repCard.textContent = rep;
                
                // Skill points
                skillPtsCard.textContent = g_pChar.m_nSkillPoints;
                
                // Health progress bar
                const healthPercent = g_pChar.m_nHealthPhysical * HEALTH_INCREMENT;
                const healthFill = healthCard.parentElement.querySelector('.stat-fill.health');
                const healthValues = healthCard;
                healthFill.style.width = healthPercent + "%";
                healthValues.textContent = healthPercent + "%";
                
                // Rent due progress bar
                let dueIn = (GetDays(g_pChar.m_nMonth,g_pChar.m_nYear) - g_pChar.m_nDayOfMonth);
                const daysInMonth = GetDays(g_pChar.m_nMonth,g_pChar.m_nYear);
                const rentPercent = ((daysInMonth - dueIn) / daysInMonth) * 100;
                const rentFill = rentCard.parentElement.querySelector('.stat-fill.time');
                const rentValues = rentCard;
                rentFill.style.width = rentPercent + "%";
                rentValues.textContent = (dueIn > 1) ? (dueIn + " days") : "Tomorrow";
                
                // Update skills
                skillElements.forEach((skillCard, index) => {
                    const skill = skillData[index];
                    const valueElement = skillCard.querySelector('.skill-value');
                    const costElement = skillCard.querySelector('.skill-cost');
                    const upgradeBtn = skillCard.querySelector('.skill-upgrade-btn');
                    
                    const currentValue = skill.getter();
                    const upgradeCost = currentValue + 1;
                    
                    valueElement.textContent = currentValue;
                    costElement.textContent = "Cost: " + upgradeCost;
                    
                    // Enable/disable upgrade button
                    if (g_pChar.m_bOnRun) {
                        upgradeBtn.disabled = true;
                    } else {
                        upgradeBtn.disabled = (upgradeCost > g_pChar.m_nSkillPoints);
                    }
                });
                
                // Lifestyle information
                const lifestyleNameElement = lifestyleCard.querySelector('.lifestyle-current');
                const costElement = lifestyleCard.querySelectorAll('.lifestyle-value')[0];
                const dueElement = lifestyleCard.querySelectorAll('.lifestyle-value')[1];
                const upgradeCostElement = lifestyleCard.querySelector('.lifestyle-cost');
                const upgradeBtn = lifestyleCard.querySelector('.lifestyle-upgrade button');
                
                lifestyleNameElement.textContent = g_pChar.GetLifestyleString();
                costElement.textContent = g_nLifestyleMonthlyCost[g_pChar.m_nLifestyle] + "cr";
                dueElement.textContent = (dueIn > 1) ? (dueIn + " days") : "Tomorrow";
                
                // Upgrade cost and button state
                if (g_pChar.m_nLifestyle !== MAX_LIFESTYLE) {
                    const upgradeCost = g_nLifestyleMonthlyCost[g_pChar.m_nLifestyle + 1] * 3; // Simplified upgrade factor
                    upgradeCostElement.textContent = "Upgrade Cost: " + upgradeCost + "cr";
                    upgradeBtn.disabled = g_pChar.m_bOnRun || g_pChar.m_nCredits < upgradeCost;
                } else {
                    upgradeCostElement.textContent = "Max Level";
                    upgradeBtn.disabled = true;
                }
            }

            function upgradeSkill(skillIndex) {
                const skill = skillData[skillIndex];
                const currentValue = skill.getter();
                const upgradeCost = currentValue + 1;
                
                if (upgradeCost <= g_pChar.m_nSkillPoints && !g_pChar.m_bOnRun) {
                    g_pChar.m_nSkillPoints -= upgradeCost;
                    skill.setter(currentValue + 1);
                    initFunc(); // Refresh the display
                }
            }

            function upgradeLifestyle() {
                if (g_pChar.m_nLifestyle < MAX_LIFESTYLE && !g_pChar.m_bOnRun) {
                    const upgradeCost = g_nLifestyleMonthlyCost[g_pChar.m_nLifestyle + 1] * 3;
                    if (g_pChar.m_nCredits >= upgradeCost) {
                        g_pChar.m_nLifestyle++;
                        g_pChar.m_nCredits -= upgradeCost;
                        initFunc();
                        alert("Lifestyle upgraded!");
                    }
                }
            }

            function viewDeck() {
                close();
                alert("Deck view would open here");
            }

            function close() {
                const overlay = document.querySelector('.popup-overlay');
                if (overlay) overlay.remove();
            }
        }
    </script>
</body>
</html>